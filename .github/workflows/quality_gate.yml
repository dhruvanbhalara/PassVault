name: Quality Gate

# Validates code quality for pull requests
# Skips execution if only documentation files are changed
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "**.md"
      - ".gitignore"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

# Least-privilege permissions for security
permissions:
  contents: read # Required for actions/checkout
  pull-requests: read # Required for paths-filter
  checks: write # Required for test reporting

env:
  FLUTTER_VERSION: ${{ secrets.FLUTTER_VERSION }}

jobs:
  validate:
    name: Validate PR Changes
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should-run: ${{ steps.filter.outputs.code == 'true' }}

    steps:
      # Use path filtering to skip workflow if only docs changed
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            code:
              - 'lib/**'
              - 'test/**'
              - 'android/**'
              - 'ios/**'
              - 'pubspec.yaml'
              - 'pubspec.lock'
              - 'analysis_options.yaml'
              - '.github/workflows/**'
              - '.github/actions/**'

  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-run == 'true'
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Use composite action for consistent Flutter setup
      - uses: ./.github/actions/flutter-setup

      - name: Format code check
        run: dart format --output=none --set-exit-if-changed .

      - name: Lint code
        run: flutter analyze --fatal-infos

  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-run == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Use composite action for consistent Flutter setup
      - uses: ./.github/actions/flutter-setup

      - name: Execute unit tests
        run: flutter test --coverage

      # Upload coverage (optional, based on requirement)
      # - name: Report code coverage
      #   uses: codecov/codecov-action@v3
      #   with:
      #     files: ./coverage/lcov.info
      #     flags: unittests
      #     fail_ci_if_error: false

  summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [quality, tests]
    if: always()
    timeout-minutes: 10
    permissions:
      pull-requests: write # Required to update PR description
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check workflow status
        run: |
          if [ "${{ needs.quality.result }}" != "success" ] || [ "${{ needs.tests.result }}" != "success" ]; then
            echo "❌ Quality gate failed"
            exit 1
          fi
          echo "✅ All quality checks passed"

      # Download coverage artifact from tests job
      - name: Download coverage
        uses: actions/upload-artifact@v4
        with:
          name: lcov-report
          path: coverage/lcov.info
        if: needs.tests.result == 'success'

      - name: Generate Coverage Summary
        id: coverage
        run: |
          SUMMARY=$(dart scripts/coverage_report.dart)
          echo "SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        if: needs.tests.result == 'success'

      - name: Update PR Description
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CURRENT_BODY=$(gh pr view $PR_NUMBER --json body -q .body)

          # Remove old coverage block if exists
          NEW_BODY=$(echo "$CURRENT_BODY" | sed '/<!-- COVERAGE_START -->/,/<!-- COVERAGE_END -->/d')

          # Append new coverage summary
          echo -e "$NEW_BODY\n\n$SUMMARY" > pr_body.txt
          gh pr edit $PR_NUMBER --body-file pr_body.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: needs.tests.result == 'success'
